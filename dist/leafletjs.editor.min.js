L.SmartEditor=L.Class.extend({statics:{Automatic:0,Manual:1},options:{},initialize:function(t){L.Util.setOptions(this,t)},setMode:function(t){if(0!=t&&1!=t)throw"Not supported mode";this.options.mode=t},getMode:function(){return this.options.mode},draw:function(t){},edit:function(t){},finish:function(){}}),L.smartEditor=function(t){return new L.SmartEditor(t)},L.Route=L.Polyline.extend({options:{smoothFactor:1,noClip:!1},initialize:function(t,e){L.Util.setOptions(this,e),this._setLatLngs(t)},reverse:function(){for(var t=this.getLatLngs(),e=new Array,i=t.length-1;i>0;i--)e.push(t[i]);this.setLatLngs(e),this.redraw()},getWaypoints:function(){for(var t=new Array,e=this.getLatLngs(),i=0;i<e.length;i++)e[i].waypoint&&t.push(e[i]);return t}}),L.route=function(t,e){return new L.Route(t,e)},L.Draw.Routing=L.Class.extend({initialize:function(t){this.greeter=t},greet:function(t){alert(this.greeter+", "+t)}}),L.Draw.Routing.Router=L.Class.extend({initialize:function(){throw"Must be overrided by Routing implementations"},route:function(){throw"Must be overrided by Routing implementations"}}),L.Draw.Routing.Router.OSM=L.Draw.Routing.Router.extend({statics:{PEDESTRIAN:"pedestrian",SHORTEST:"shortest",FASTEST:"fastest",BICYCLE:"bicycle",MULTIMODAL:"multimodal"},options:{routingMode:"pedestrian"},initialize:function(t){null!=t&&(this.options.routingMode=t)},getRoutingMode:function(){return this.options.routingMode},route:function(t){console.log("route: ",t),Array.isArray(t)&&(t={from:t[0],to:t[1]});var e=this;return new Promise(function(i,o){var s=[];if(t.waypoints&&t.waypoints.length>0)for(var n=0;n<t.waypoints.length;n++)s.push(t.waypoints[n].lat+","+t.waypoints[n].lng);s.push(t.to.lat+","+t.to.lng),jQuery.ajaxSettings.traditional=!0,$.get("https://open.mapquestapi.com/directions/v2/route",{key:"Fmjtd%7Cluu82lu22d%2C70%3Do5-948lqu",narrativeType:"none",unit:"k",outFormat:"json",fullShape:!1,generalize:"1",routeType:e.getRoutingMode(),from:t.from.lat+","+t.from.lng,to:s,outFormat:"json"}).done(function(t){var o=e._convertOSMToPath(t);i(o)}).fail(function(t){o(t)})})},_convertOSMToPath:function(t){for(var e=new Array,i=t.route.shape.shapePoints,o=1;o<i.length;o+=2){var s=i[o-1],n=i[o],r=L.latLng(s,n);e.push(r)}return e}}),L.Draw.Polyline.include({options:{allowIntersection:!0,repeatMode:!1,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!1,clickable:!0,outlineWidth:3,outlineColor:"#FFFFFF",poly:{lazyMode:!1}},metric:!0,feet:!0,nautic:!1,showLength:!0,zIndexOffset:2e3},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new L.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("mouseout",this._onMouseOut,this).on("mousemove",this._onMouseMove,this).on("mousedown",this._onMouseDown,this).on("mouseup",this._onMouseUp,this).addTo(this._map),this._map.on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).on("zoomlevelschange",this._onZoomEnd,this).on("touchstart",this._onTouch,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this).off("touchstart",this._onTouch,this).off("click",this._onTouch,this)},deleteLastVertex:function(){if(!(this._markers.length<1||this._poly.getLatLngs().length<=1)){var t=this._markers.pop(),e=this._poly,i=e.getLatLngs(),o=i.splice(-1,1)[0];if(this._poly.setLatLngs(i),this._markerGroup.removeLayer(t),e.getLatLngs().length<2&&this._map.removeLayer(e),this.options.shapeOptions.poly.lazyMode){var s=this._poly.getLatLngs()[this._poly.getLatLngs().length-1];this._markers.push(this._createMarker(s))}this._vertexChanged(o,!1)}},addVertex:function(t){this._markers.length>=2&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(t)?this._showErrorTooltip():(this._errorShown&&this._hideErrorTooltip(),null!=this.options.shapeOptions.poly&&null!=this.options.shapeOptions.poly.lazyMode&&this._clearMarkers(),this._markers.push(this._createMarker(t)),this._poly.addLatLng(t),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),this._vertexChanged(t,!0))},redrawVertices:function(t){for(var e=0;e<t.length;e++)this._poly.addLatLng(t[e]);this._poly.getLatLngs().length>=2&&this._map.addLayer(this._poly)},completeShape:function(){this._poly.getLatLngs().length<=1||(this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable())},_finishShape:function(){var t=this._poly._defaultShape?this._poly._defaultShape():this._poly.getLatLngs(),e=this._poly.newLatLngIntersects(t[t.length-1]);!this.options.allowIntersection&&e||!this._shapeIsValid()?this._showErrorTooltip():(this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable())},_shapeIsValid:function(){return!0},_onZoomEnd:function(){null!==this._markers&&this._updateGuide()},_onMouseMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent),i=this._map.layerPointToLatLng(e);this._currentLatLng=i,this._updateTooltip(i),this._updateGuide(e),this._mouseMarker.setLatLng(i),L.DomEvent.preventDefault(t.originalEvent)},_vertexChanged:function(t,e){this._map.fire(L.Draw.Event.DRAWVERTEX,{layers:this._markerGroup,poly:this._poly}),this._updateFinishHandler(),this._updateRunningMeasure(t,e),this._clearGuides(),this._updateTooltip()},_onMouseDown:function(t){if(!this._clickHandled&&!this._touchHandled&&!this._disableMarkers){this._onMouseMove(t),this._clickHandled=!0,this._disableNewMarkers();var e=t.originalEvent,i=e.clientX,o=e.clientY;this._startPoint.call(this,i,o)}},_startPoint:function(t,e){this._mouseDownOrigin=L.point(t,e)},_onMouseUp:function(t){var e=t.originalEvent,i=e.clientX,o=e.clientY;this._endPoint.call(this,i,o,t),this._clickHandled=null},_endPoint:function(t,e,i){if(this._mouseDownOrigin){var o=L.point(t,e).distanceTo(this._mouseDownOrigin);this._calculateFinishDistance(i.latlng)<10&&L.Browser.touch?this._finishShape():Math.abs(o)<9*(window.devicePixelRatio||1)&&this.addVertex(i.latlng),this._enableNewMarkers()}this._mouseDownOrigin=null},_onTouch:function(t){if(0!=L.Browser.touch){var e,i,o=t.originalEvent;!o.touches||!o.touches[0]||this._clickHandled||this._touchHandled||this._disableMarkers||(e=o.touches[0].clientX,i=o.touches[0].clientY,this._disableNewMarkers(),this._touchHandled=!0,this._startPoint.call(this,e,i),this._endPoint.call(this,e,i,t),this._touchHandled=null),this._clickHandled=null}},_onMouseOut:function(){this._tooltip&&this._tooltip._onMouseOut.call(this._tooltip)},_calculateFinishDistance:function(t){var e;if(this._markers.length>0){var i;if(this.type===L.Draw.Polyline.TYPE)i=this._markers[this._markers.length-1];else{if(this.type!==L.Draw.Polygon.TYPE)return 1/0;i=this._markers[0]}var o=this._map.latLngToContainerPoint(i.getLatLng()),s=new L.Marker(t,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset}),n=this._map.latLngToContainerPoint(s.getLatLng());e=o.distanceTo(n)}else e=1/0;return e},_updateFinishHandler:function(){var t=this._markers.length;t>1&&this._markers[t-1].on("click",this._finishShape,this),t>2&&this._markers[t-2].off("click",this._finishShape,this)},_createMarker:function(t){var e=new L.Marker(t,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset});return this._markerGroup.addLayer(e),e},_clearMarkers:function(){this._markerGroup.clearLayers(),this._markers=[]},_updateGuide:function(t){var e=this._markers?this._markers.length:0;e>0&&(t=t||this._map.latLngToLayerPoint(this._currentLatLng),this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._markers[e-1].getLatLng()),t))},_updateTooltip:function(t){var e=this._getTooltipText();t&&this._tooltip.updatePosition(t),this._errorShown||this._tooltip.updateContent(e)},_drawGuide:function(t,e){var i,o,s,n=Math.floor(Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))),r=this.options.guidelineDistance,a=this.options.maxGuideLineLength,h=n>a?n-a:r;for(this._guidesContainer||(this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane));h<n;h+=this.options.guidelineDistance)i=h/n,o={x:Math.floor(t.x*(1-i)+i*e.x),y:Math.floor(t.y*(1-i)+i*e.y)},(s=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer)).style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,L.DomUtil.setPosition(s,o)},_updateGuideColor:function(t){if(this._guidesContainer)for(var e=0,i=this._guidesContainer.childNodes.length;e<i;e++)this._guidesContainer.childNodes[e].style.backgroundColor=t},_clearGuides:function(){if(this._guidesContainer)for(;this._guidesContainer.firstChild;)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var t,e,i=this.options.showLength;return L.Browser.touch&&(i=!1),0===this._markers.length?t={text:L.drawLocal.draw.handlers.polyline.tooltip.start}:(e=i?this._getMeasurementString():"",t=1===this._markers.length?{text:L.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:e}:{text:L.drawLocal.draw.handlers.polyline.tooltip.end,subtext:e}),t},_updateRunningMeasure:function(t,e){var i,o,s=this._poly.getLatLngs().length;1===this._poly.getLatLngs().length?this._measurementRunningTotal=0:(i=s-(e?2:1),o=t.distanceTo(this._poly.getLatLngs()[i]),this._measurementRunningTotal+=o*(e?1:-1))},_getMeasurementString:function(){var t,e=this._currentLatLng,i=this._markers[this._markers.length-1].getLatLng();return t=this._measurementRunningTotal+e.distanceTo(i),L.GeometryUtil.readableDistance(t,this.options.metric,this.options.feet,this.options.nautic)},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_disableNewMarkers:function(){this._disableMarkers=!0},_enableNewMarkers:function(){setTimeout(function(){this._disableMarkers=!1}.bind(this),50)},_cleanUpShape:function(){this._markers.length>1&&this._markers[this._markers.length-1].off("click",this._finishShape,this)},_fireCreatedEvent:function(){var t=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,t)}}),L.Draw.Route=L.Draw.Polyline.extend({statics:{TYPE:"route"},Poly:L.Route,options:{allowIntersection:!0,repeatMode:!1,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!1,clickable:!0,outlineWidth:3,outlineColor:"#FFFFFF",poly:{lazyMode:!0,router:null}},metric:!0,feet:!0,nautic:!1,showLength:!0,zIndexOffset:2e3},initialize:function(t,e){L.Draw.Polyline.prototype.initialize.call(this,t,e),this.type=L.Draw.Route.TYPE,L.setOptions(this,e)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new L.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("mouseout",this._onMouseOut,this).on("mousemove",this._onMouseMove,this).on("mousedown",this._onMouseDown,this).on("mouseup",this._onMouseUp,this).addTo(this._map),this._map.on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).on("zoomlevelschange",this._onZoomEnd,this).on("touchstart",this._onTouch,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this).off("touchstart",this._onTouch,this).off("click",this._onTouch,this)},deleteLastVertex:function(){if(!(this._markers.length<1||this._poly.getLatLngs().length<=1)){var t=this._markers.pop(),e=this._poly,i=e.getLatLngs(),o=i.splice(-1,1)[0];if(this._poly.setLatLngs(i),this._markerGroup.removeLayer(t),e.getLatLngs().length<2&&this._map.removeLayer(e),this.options.shapeOptions.poly.lazyMode){var s=this._poly.getLatLngs()[this._poly.getLatLngs().length-1];this._markers.push(this._createMarker(s))}this._vertexChanged(o,!1)}},addVertex:function(t){this._markers.length>=2&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(t)?this._showErrorTooltip():(this._errorShown&&this._hideErrorTooltip(),null!=this.options.shapeOptions.poly&&null!=this.options.shapeOptions.poly.lazyMode&&this._clearMarkers(),t.waypoint=!0,this._markers.push(this._createMarker(t)),this._poly.addLatLng(t),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),this._vertexChanged(t,!0))},askForRoute:function(t){var e=this,i=this._poly.getLatLngs()[this._poly.getLatLngs().length-1];if(null!=i){var o={from:i,to:t};this.options.shapeOptions.poly.router.route(o).then(function(t){e.addRouteVertex(t)}).catch(function(t){console.log("error: "+t)})}else this.addVertex(t)},addRouteVertex:function(t){if(!(null==t||t.length<=0)){var e=t[t.length-1];e.waypoint=!0,this._markers.length>=2&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(e)?this._showErrorTooltip():(this._errorShown&&this._hideErrorTooltip(),this.options.shapeOptions.poly.lazyMode&&this._clearMarkers(),this.redrawVertices(t),this._markers.push(this._createMarker(e)),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),this._vertexChanged(e,!0))}},redrawVertices:function(t){for(var e=0;e<t.length;e++)this._poly.addLatLng(t[e]);this._poly.getLatLngs().length>=2&&this._map.addLayer(this._poly)},completeShape:function(){this._poly.getLatLngs().length<=1||(this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable())},_finishShape:function(){var t=this._poly._defaultShape?this._poly._defaultShape():this._poly.getLatLngs(),e=this._poly.newLatLngIntersects(t[t.length-1]);!this.options.allowIntersection&&e||!this._shapeIsValid()?this._showErrorTooltip():(this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable())},_shapeIsValid:function(){return!0},_onZoomEnd:function(){null!==this._markers&&this._updateGuide()},_onMouseMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent),i=this._map.layerPointToLatLng(e);this._currentLatLng=i,this._updateTooltip(i),this._updateGuide(e),this._mouseMarker.setLatLng(i),L.DomEvent.preventDefault(t.originalEvent)},_vertexChanged:function(t,e){this._map.fire(L.Draw.Event.DRAWVERTEX,{layers:this._markerGroup,poly:this._poly}),this._updateFinishHandler(),this._updateRunningMeasure(t,e),this._clearGuides(),this._updateTooltip()},_onMouseDown:function(t){if(!this._clickHandled&&!this._touchHandled&&!this._disableMarkers){this._onMouseMove(t),this._clickHandled=!0,this._disableNewMarkers();var e=t.originalEvent,i=e.clientX,o=e.clientY;this._startPoint.call(this,i,o)}},_startPoint:function(t,e){this._mouseDownOrigin=L.point(t,e)},_onMouseUp:function(t){var e=t.originalEvent,i=e.clientX,o=e.clientY;this._endPoint.call(this,i,o,t),this._clickHandled=null},_endPoint:function(t,e,i){if(this._mouseDownOrigin){var o=L.point(t,e).distanceTo(this._mouseDownOrigin);this._calculateFinishDistance(i.latlng)<10&&L.Browser.touch?this._finishShape():Math.abs(o)<9*(window.devicePixelRatio||1)&&(null!=this.options.shapeOptions.poly&&null!=this.options.shapeOptions.poly.router?this.askForRoute(i.latlng):this.addVertex(i.latlng)),this._enableNewMarkers()}this._mouseDownOrigin=null},_onTouch:function(t){if(0!=L.Browser.touch){var e,i,o=t.originalEvent;!o.touches||!o.touches[0]||this._clickHandled||this._touchHandled||this._disableMarkers||(e=o.touches[0].clientX,i=o.touches[0].clientY,this._disableNewMarkers(),this._touchHandled=!0,this._startPoint.call(this,e,i),this._endPoint.call(this,e,i,t),this._touchHandled=null),this._clickHandled=null}},_onMouseOut:function(){this._tooltip&&this._tooltip._onMouseOut.call(this._tooltip)},_calculateFinishDistance:function(t){var e;if(this._markers.length>0){var i;if(this.type===L.Draw.Polyline.TYPE)i=this._markers[this._markers.length-1];else{if(this.type!==L.Draw.Polygon.TYPE)return 1/0;i=this._markers[0]}var o=this._map.latLngToContainerPoint(i.getLatLng()),s=new L.Marker(t,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset}),n=this._map.latLngToContainerPoint(s.getLatLng());e=o.distanceTo(n)}else e=1/0;return e},_updateFinishHandler:function(){var t=this._markers.length;t>1&&this._markers[t-1].on("click",this._finishShape,this),t>2&&this._markers[t-2].off("click",this._finishShape,this)},_createMarker:function(t){var e=new L.Marker(t,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset});return this._markerGroup.addLayer(e),e},_clearMarkers:function(){this._markerGroup.clearLayers(),this._markers=[]},_updateGuide:function(t){var e=this._markers?this._markers.length:0;e>0&&(t=t||this._map.latLngToLayerPoint(this._currentLatLng),this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._markers[e-1].getLatLng()),t))},_updateTooltip:function(t){var e=this._getTooltipText();t&&this._tooltip.updatePosition(t),this._errorShown||this._tooltip.updateContent(e)},_drawGuide:function(t,e){var i,o,s,n=Math.floor(Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))),r=this.options.guidelineDistance,a=this.options.maxGuideLineLength,h=n>a?n-a:r;for(this._guidesContainer||(this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane));h<n;h+=this.options.guidelineDistance)i=h/n,o={x:Math.floor(t.x*(1-i)+i*e.x),y:Math.floor(t.y*(1-i)+i*e.y)},(s=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer)).style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,L.DomUtil.setPosition(s,o)},_updateGuideColor:function(t){if(this._guidesContainer)for(var e=0,i=this._guidesContainer.childNodes.length;e<i;e++)this._guidesContainer.childNodes[e].style.backgroundColor=t},_clearGuides:function(){if(this._guidesContainer)for(;this._guidesContainer.firstChild;)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var t,e,i=this.options.showLength;return L.Browser.touch&&(i=!1),0===this._markers.length?t={text:L.drawLocal.draw.handlers.polyline.tooltip.start}:(e=i?this._getMeasurementString():"",t=1===this._markers.length?{text:L.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:e}:{text:L.drawLocal.draw.handlers.polyline.tooltip.end,subtext:e}),t},_updateRunningMeasure:function(t,e){var i,o,s=this._poly.getLatLngs().length;1===this._poly.getLatLngs().length?this._measurementRunningTotal=0:(i=s-(e?2:1),o=t.distanceTo(this._poly.getLatLngs()[i]),this._measurementRunningTotal+=o*(e?1:-1))},_getMeasurementString:function(){var t,e=this._currentLatLng,i=this._markers[this._markers.length-1].getLatLng();return t=this._measurementRunningTotal+e.distanceTo(i),L.GeometryUtil.readableDistance(t,this.options.metric,this.options.feet,this.options.nautic)},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_disableNewMarkers:function(){this._disableMarkers=!0},_enableNewMarkers:function(){setTimeout(function(){this._disableMarkers=!1}.bind(this),50)},_cleanUpShape:function(){this._markers.length>1&&this._markers[this._markers.length-1].off("click",this._finishShape,this)},_fireCreatedEvent:function(){var t=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,t)}}),L.Edit.Poly.include({_initHandlers:function(){if(this._verticesHandlers=[],this._poly instanceof L.Route)for(t=0;t<this.latlngs.length;t++)this._verticesHandlers.push(new L.Edit.RouteVerticesEdit(this._poly,this.latlngs[t],this.options));else for(var t=0;t<this.latlngs.length;t++)this._verticesHandlers.push(new L.Edit.PolyVerticesEdit(this._poly,this.latlngs[t],this.options))}}),L.Edit.PolyVerticesEdit.include({addHooks:function(){var t=this._poly;t instanceof L.Polygon||(t.options.fill=!1,t.options.editing&&(t.options.editing.fill=!1)),t.setStyle(t.options.editing),this._poly._map&&(this._map=this._poly._map,this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup),this.options.lazyMode&&this._poly._map.on("mousemove",this._handleMouseOver,this))},removeHooks:function(){var t=this._poly;t.setStyle(t.options.original),t._map&&(t._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this.options.lazyMode&&this._poly._map.off("mousemove",this._handleMouseOver,this))},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var t,e,i,o,s=this._defaultShape();if(!this.options.lazyMode){for(t=0,i=s.length;t<i;t++)(o=this._createMarker(s[t],t)).on("click",this._onMarkerClick,this),this._markers.push(o);var n,r;for(t=0,e=i-1;t<i;e=t++)(0!==t||L.Polygon&&this._poly instanceof L.Polygon)&&(n=this._markers[e],r=this._markers[t],this._createMiddleMarker(n,r),this._updatePrevNext(n,r))}},_handleMouseOver:function(t){if(!this._dragging){for(var e,i=2e4,o=this._defaultShape(),s=1;s<o.length;s++){var n=this._map.latLngToLayerPoint(o[s-1]),r=this._map.latLngToLayerPoint(o[s]),a=L.LineUtil.pointToSegmentDistance(t.layerPoint,n,r);a<i&&(e=s,i=a)}var h=o[e];if(null==this._nearMarker||this._nearMarker.getLatLng().lat!=h.lat||this._nearMarker.getLatLng().lng!=h.lng){this._markerGroup.clearLayers(),this._markers=[];for(s=e+3;s>e-3;s--){var l=this._createMarker(o[s],s);null!=l&&(l.on("click",this._onMarkerClick,this),this._markers.push(l),s==e&&(this._nearMarker=l))}var _,d,u,p=this._markers.length;for(s=0,u=p-1;s<p;u=s++)(0!==s||L.Polygon&&this._poly instanceof L.Polygon)&&(_=this._markers[u],d=this._markers[s],this._createMiddleMarker(d,_),this._updatePrevNext(d,_))}}},_createMarker:function(t,e){if(null!=t){var i=new L.Marker.Touch(t,{draggable:!0,icon:this.options.icon});return i._origLatLng=t,i._index=e,i.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("touchend",this._fireEdit,this).on("MSPointerMove",this._onTouchMove,this).on("MSPointerUp",this._fireEdit,this),this._markerGroup.addLayer(i),i}},_onMarkerDragStart:function(){this._poly.fire("editstart"),this._dragging=!0},_spliceLatLngs:function(){var t=this._defaultShape(),e=[].splice.apply(t,arguments);return this._poly._convertLatLngs(t,!0),this._poly.redraw(),e},_removeMarker:function(t){var e=t._index;this._markerGroup.removeLayer(t),this._markers.splice(e,1),this._spliceLatLngs(e,1),this._updateIndexes(e,-1),t.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._fireEdit,this).off("click",this._onMarkerClick,this).off("MSPointerMove",this._onTouchMove,this).off("MSPointerUp",this._fireEdit,this)},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit"),this._poly._map.fire(L.Draw.Event.EDITVERTEX,{layers:this._markerGroup,poly:this._poly}),this._dragging=!1},_onMarkerDrag:function(t){var e=t.target,i=this._poly;if(L.extend(e._origLatLng,e._latlng),e._origLatLng.alt=null,e._middleLeft&&e._middleLeft.setLatLng(this._getMiddleLatLng(e._prev,e)),e._middleRight&&e._middleRight.setLatLng(this._getMiddleLatLng(e,e._next)),i.options.poly){var o=i._map._editTooltip;if(!i.options.poly.allowIntersection&&i.intersects()){var s=i.options.color;i.setStyle({color:this.options.drawError.color}),0!==L.version.indexOf("0.7")&&e.dragging._draggable._onUp(t),this._onMarkerClick(t),o&&o.updateContent({text:L.drawLocal.draw.handlers.polyline.error}),setTimeout(function(){i.setStyle({color:s}),o&&o.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext})},1e3)}}this._poly.redraw(),this._poly.fire("editdrag")},_onMarkerClick:function(t){var e=L.Polygon&&this._poly instanceof L.Polygon?4:3,i=t.target;this._defaultShape().length<e||(this._removeMarker(i),this._updatePrevNext(i._prev,i._next),i._middleLeft&&this._markerGroup.removeLayer(i._middleLeft),i._middleRight&&this._markerGroup.removeLayer(i._middleRight),i._prev&&i._next?this._createMiddleMarker(i._prev,i._next):i._prev?i._next||(i._prev._middleRight=null):i._next._middleLeft=null,this._fireEdit())},_onTouchMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent.touches[0]),i=this._map.layerPointToLatLng(e),o=t.target;L.extend(o._origLatLng,i),o._middleLeft&&o._middleLeft.setLatLng(this._getMiddleLatLng(o._prev,o)),o._middleRight&&o._middleRight.setLatLng(this._getMiddleLatLng(o,o._next)),this._poly.redraw(),this.updateMarkers()},_updateIndexes:function(t,e){this._markerGroup.eachLayer(function(i){i._index>t&&(i._index+=e)})},_createMiddleMarker:function(t,e){var i,o,s,n=this._getMiddleLatLng(t,e),r=this._createMarker(n);r.setOpacity(.6),t._middleRight=e._middleLeft=r,o=function(){r.off("touchmove",o,this);var s=e._index;r._index=s,r.off("click",i,this).on("click",this._onMarkerClick,this),n.lat=r.getLatLng().lat,n.lng=r.getLatLng().lng,this._spliceLatLngs(s,0,n),this._markers.splice(s,0,r),r.setOpacity(1),this._updateIndexes(s,1),e._index++,this._updatePrevNext(t,r),this._updatePrevNext(r,e),this._poly.fire("editstart")},s=function(){r.off("dragstart",o,this),r.off("dragend",s,this),r.off("touchmove",o,this),this._createMiddleMarker(t,r),this._createMiddleMarker(r,e)},i=function(){o.call(this),s.call(this),this._fireEdit()},r.on("click",i,this).on("dragstart",o,this).on("dragend",s,this).on("touchmove",o,this),this._markerGroup.addLayer(r)},_updatePrevNext:function(t,e){t&&(t._next=e),e&&(e._prev=t)},_getMiddleLatLng:function(t,e){var i=this._poly._map,o=i.project(t.getLatLng()),s=i.project(e.getLatLng());return i.unproject(o._add(s)._divideBy(2))}}),L.Edit.RouteVerticesEdit=L.Edit.PolyVerticesEdit.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),drawError:{color:"#b00b00",timeout:1e3},lazyMode:!0},_startDragIndex:-1,_endDragIndex:-1,_routeNoWaypoints:!1,initialize:function(t,e,i){L.Browser.touch&&(this.options.icon=this.options.touchIcon),this._poly=t,i&&i.drawError&&(i.drawError=L.Util.extend({},this.options.drawError,i.drawError)),this._latlngs=e,L.setOptions(this,i)},addHooks:function(){var t=this._poly;t.options.fill=!1,t.options.editing&&(t.options.editing.fill=!1),t.setStyle(t.options.editing),this._poly._map&&(this._map=this._poly._map,this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup),this.options.lazyMode&&this._poly._map.on("mousemove",this._handleMouseOver,this))},removeHooks:function(){var t=this._poly;t.setStyle(t.options.original),t._map&&(t._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this.options.lazyMode&&this._poly._map.off("mousemove",this._handleMouseOver,this))},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var t,e,i,o,s=this._defaultShape();if(!this.options.lazyMode){for(t=0,i=s.length;t<i;t++)(o=this._createMarker(s[t],t)).on("click",this._onMarkerClick,this),this._markers.push(o);var n,r;for(t=0,e=i-1;t<i;e=t++)(0!==t||L.Polygon&&this._poly instanceof L.Polygon)&&(n=this._markers[e],r=this._markers[t],this._createMiddleMarker(n,r),this._updatePrevNext(n,r))}},_getHooks:function(){return null==this.options.router?this._poly.getLatLngs():this._poly.getWaypoints()},_handleMouseOver:function(t){if(!this._dragging){for(var e,i=2e4,o=this._getHooks(),s=1;s<o.length;s++){var n=this._map.latLngToLayerPoint(o[s-1]),r=this._map.latLngToLayerPoint(o[s]),a=L.LineUtil.pointToSegmentDistance(t.layerPoint,n,r);a<i&&(e=s,i=a)}var h=o[e];if(null==this._nearMarker||this._nearMarker.getLatLng().lat!=h.lat||this._nearMarker.getLatLng().lng!=h.lng){this._markerGroup.clearLayers(),this._markers=[];for(s=e+3;s>e-3;s--){var l=this._createMarker(o[s],s);null!=l&&(l.on("click",this._onMarkerClick,this),this._markers.push(l),s==e&&(this._nearMarker=l))}var _,d,u,p=this._markers.length;for(s=0,u=p-1;s<p;u=s++)(0!==s||L.Polygon&&this._poly instanceof L.Polygon)&&(_=this._markers[u],d=this._markers[s],this._createMiddleMarker(d,_),this._updatePrevNext(d,_))}}},_createMarker:function(t,e){if(null!=t){var i=new L.Marker.Touch(t,{draggable:!0,icon:this.options.icon});return i._origLatLng=t,i._index=e,i.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this).on("touchmove",this._onTouchMove,this).on("touchend",this._onMarkerDragEnd,this).on("MSPointerMove",this._onTouchMove,this).on("MSPointerUp",this._onMarkerDragEnd,this),this._markerGroup.addLayer(i),i}},_spliceLatLngs:function(){var t=this._defaultShape(),e=[].splice.apply(t,arguments);return this._poly._convertLatLngs(t,!0),this._poly.redraw(),e},_removeMarker:function(t){var e=t._index;this._markerGroup.removeLayer(t),this._markers.splice(e,1),this._spliceLatLngs(e,1),this._updateIndexes(e,-1),t.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._onMarkerDragEnd,this).off("click",this._onMarkerClick,this).off("MSPointerMove",this._onTouchMove,this).off("MSPointerUp",this._onMarkerDragEnd,this)},_findWaypointIndex:function(t){for(var e=this._poly.getLatLngs(),i=0;i<e.length;i++)if(e[i]==t)return i;return-1},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit"),this._poly._map.fire(L.Draw.Event.EDITVERTEX,{layers:this._markerGroup,poly:this._poly}),this._dragging=!1},_onMarkerDrag:function(t){var e=t.target,i=this._poly;if(L.extend(e._origLatLng,e._latlng),e._origLatLng.alt=null,e._middleLeft&&e._middleLeft.setLatLng(this._getMiddleLatLng(e._prev,e)),e._middleRight&&e._middleRight.setLatLng(this._getMiddleLatLng(e,e._next)),i.options.poly)i._map._editTooltip;this._poly.redraw(),this._poly.fire("editdrag")},_onMarkerDragStart:function(t){var e=t.target;if(this._poly.fire("editstart"),this._dragging=!0,null!=this._poly.options.poly.router){this._routeNoWaypoints=!1,null!=e._prev?this._startDragIndex=this._findWaypointIndex(e._prev.getLatLng()):(this._startDragIndex=0,this._routeNoWaypoints=!0),null!=e._next?this._endDragIndex=this._findWaypointIndex(e._next.getLatLng()):(this._endDragIndex=this._poly.getLatLngs().length-1,this._routeNoWaypoints=!0);var i=this._endDragIndex-this._startDragIndex;console.log("indices: ",this._startDragIndex,this._endDragIndex),0==this._routeNoWaypoints?this._poly.getLatLngs().splice(this._startDragIndex+1,i-1,e.getLatLng()):this._poly.getLatLngs().splice(this._startDragIndex+1,i-1),this._poly.redraw()}},_onMarkerDragEnd:function(){var t,e=this._poly,i=e.getLatLngs()[this._startDragIndex],o=null;0==this._startDragIndex&&this._routeNoWaypoints?(o=null,t=e.getLatLngs()[this._startDragIndex+1]):this._startDragIndex==e.getLatLngs().length-2&&this._routeNoWaypoints?(o=null,t=e.getLatLngs()[this._startDragIndex+1]):(o=e.getLatLngs()[this._startDragIndex+1],t=e.getLatLngs()[this._startDragIndex+2]),null!=this._poly.options.poly.router&&(console.log("Ask for route with: ",i,t,o),this.askForRoute(i,t,o)),this._fireEdit()},askForRoute:function(t,e,i){var o=this,s={from:t,to:e};null!=i&&(s.waypoints=[i]),this._poly.options.poly.router.route(s).then(function(t){0==o._routeNoWaypoints&&(t[o._getNearestIndexLatLngForRoute(t,i)].waypoint=!0);var e;e=o._routeNoWaypoints?0:1,console.log(t),console.log("length to remove: ",e),o._poly.getLatLngs().splice.apply(o._poly.getLatLngs(),[o._startDragIndex+1,e].concat(t)),o._poly.redraw(),o._startDragIndex=-1,o._endDragIndex=-1,o._routeNoWaypoints=!1,o._fireEdit()}).catch(function(t){console.error("error: ",t)})},_getNearestIndexLatLngForRoute:function(t,e){for(var i=999999999,o=-1,s=0;s<t.length;s++){var n=t[s].distanceTo(e);n<i&&(i=n,o=s)}return console.log(o),o},_onMarkerClick:function(t){var e=L.Polygon&&this._poly instanceof L.Polygon?4:3,i=t.target;this._defaultShape().length<e||(this._removeMarker(i),this._updatePrevNext(i._prev,i._next),i._middleLeft&&this._markerGroup.removeLayer(i._middleLeft),i._middleRight&&this._markerGroup.removeLayer(i._middleRight),i._prev&&i._next?this._createMiddleMarker(i._prev,i._next):i._prev?i._next||(i._prev._middleRight=null):i._next._middleLeft=null,this._fireEdit())},_onTouchMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent.touches[0]),i=this._map.layerPointToLatLng(e),o=t.target;L.extend(o._origLatLng,i),o._middleLeft&&o._middleLeft.setLatLng(this._getMiddleLatLng(o._prev,o)),o._middleRight&&o._middleRight.setLatLng(this._getMiddleLatLng(o,o._next)),this._poly.redraw(),this.updateMarkers()},_updateIndexes:function(t,e){this._markerGroup.eachLayer(function(i){i._index>t&&(i._index+=e)})},_createMiddleMarker:function(t,e){var i,o,s,n=this._getMiddleLatLng(t,e),r=this._createMarker(n);r.setOpacity(.6),t._middleRight=e._middleLeft=r,o=function(){r.off("touchmove",o,this);var s=e._index;r._index=s,r.off("click",i,this).on("click",this._onMarkerClick,this),n.lat=r.getLatLng().lat,n.lng=r.getLatLng().lng,this._spliceLatLngs(s,0,n),this._markers.splice(s,0,r),r.setOpacity(1),this._updateIndexes(s,1),e._index++,this._updatePrevNext(t,r),this._updatePrevNext(r,e),this._poly.fire("editstart")},s=function(){r.off("dragstart",o,this),r.off("dragend",s,this),r.off("touchmove",o,this),this._createMiddleMarker(t,r),this._createMiddleMarker(r,e)},i=function(){o.call(this),s.call(this),this._fireEdit()},r.on("click",i,this).on("dragstart",o,this).on("dragend",s,this).on("touchmove",o,this),this._markerGroup.addLayer(r)},_updatePrevNext:function(t,e){t&&(t._next=e),e&&(e._prev=t)},_getMiddleLatLng:function(t,e){var i=this._poly._map,o=i.project(t.getLatLng()),s=i.project(e.getLatLng());return i.unproject(o._add(s)._divideBy(2))}}),L.Polyline.addInitHook(function(){this.editing||(L.Edit.Poly&&(this.editing=new L.Edit.Poly(this,this.options.poly),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()}))});